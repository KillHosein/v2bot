# تغییرات: قابل تغییر کردن متن‌های ربات

## خلاصه تغییرات

این بروزرسانی دو مشکل اصلی را برطرف می‌کند:

### 1. رفع مشکل انتخاب پنل ساخت اکانت تست ✅

**مشکل قبلی:**
- تابع `admin_set_trial_panel_start` از `reply_text` استفاده می‌کرد که باعث ایجاد پیام جدید می‌شد
- این مشکل تجربه کاربری ضعیفی ایجاد می‌کرد

**راه‌حل:**
- تابع بروزرسانی شد و اکنون از `_safe_edit_text` استفاده می‌کند
- پیام قبلی ویرایش می‌شود به جای ایجاد پیام جدید
- با fallback به `reply_text` در صورت خطا

**فایل‌های تغییر یافته:**
- `bot/handlers/admin.py` (خطوط 4359-4376)

---

### 2. قابل تغییر کردن تمام متن‌های ربات ✅

**مشکل قبلی:**
- متن‌های زیادی در کد هارد‌کد شده بودند
- ادمین نمی‌توانست این متن‌ها را از طریق پنل تغییر دهد
- برای تغییر هر متن باید کد را ویرایش می‌کرد

**راه‌حل:**
- تابع کمکی `get_message_text()` به `bot/db.py` اضافه شد
- متن‌های پیش‌فرض جدید به `initialize_default_content()` اضافه شدند
- handler ها بروزرسانی شدند تا از دیتابیس متن بخوانند

**متن‌های قابل تغییر جدید:**
- ✅ مدیریت پیام‌ها و صفحات
- ✅ مدیریت کاربران
- ✅ آمار ربات
- ✅ مدیریت پنل‌ها
- ✅ مدیریت پلن‌ها
- ✅ مدیریت کارت‌های بانکی
- ✅ تنظیمات کلی ربات
- ✅ انتخاب پنل ساخت تست
- ✅ انتخاب اینباند کانفیگ تست

**فایل‌های تغییر یافته:**
- `bot/db.py` (اضافه شدن `get_message_text()` و متن‌های پیش‌فرض)
- `bot/handlers/admin.py` (استفاده از `get_message_text`)
- `bot/handlers/admin_messages.py` (استفاده از `get_message_text`)

---

## نحوه استفاده

### برای ربات‌های جدید:
متن‌های پیش‌فرض به صورت خودکار در اولین اجرا به دیتابیس اضافه می‌شوند.

### برای ربات‌های موجود:
1. اسکریپت بروزرسانی را اجرا کنید:
```bash
python3 update_messages.py
```

2. یا دستی از طریق پنل ادمین:
   - به منوی **"مدیریت پیام‌ها"** بروید
   - دکمه **"➕ افزودن پیام جدید"** را بزنید
   - متن‌های زیر را با نام‌های مشخص شده اضافه کنید:

| نام پیام | متن پیش‌فرض |
|----------|-------------|
| `admin_messages_menu` | مدیریت پیام‌ها و صفحات: |
| `admin_users_menu` | 👥 مدیریت کاربران |
| `admin_stats_title` | 📈 **آمار ربات** |
| `admin_panels_menu` | 🖥️ مدیریت پنل‌ها |
| `admin_plans_menu` | 📋 مدیریت پلن‌ها |
| `admin_cards_menu` | 💳 مدیریت کارت‌های بانکی |
| `admin_settings_menu` | ⚙️ **تنظیمات کلی ربات** |
| `trial_panel_select` | پنل ساخت تست را انتخاب کنید: |
| `trial_inbound_select` | متن توضیحات انتخاب اینباند |

---

## ویرایش متن‌ها از طریق پنل ادمین

پس از بروزرسانی، می‌توانید تمام این متن‌ها را به راحتی ویرایش کنید:

1. وارد ربات شوید
2. به **پنل ادمین** بروید
3. گزینه **"📝 مدیریت پیام‌ها"** را انتخاب کنید
4. پیامی که می‌خواهید ویرایش کنید را انتخاب کنید
5. از دکمه **"✏️ ویرایش متن"** استفاده کنید
6. متن جدید را ارسال کنید

---

## مزایا

✅ **انعطاف‌پذیری**: تمام متن‌ها قابل تغییر هستند بدون نیاز به دانش برنامه‌نویسی

✅ **سهولت استفاده**: ویرایش از طریق رابط کاربری ربات

✅ **چندزبانه**: می‌توانید متن‌ها را به هر زبانی تغییر دهید

✅ **سازگاری**: کد قدیمی با مقادیر پیش‌فرض کار می‌کند

✅ **بدون نیاز به راه‌اندازی مجدد**: تغییرات بلافاصله اعمال می‌شوند

---

## نکات فنی

### تابع `get_message_text()`

```python
def get_message_text(message_name: str, default: str = '') -> str:
    """دریافت متن پیام از دیتابیس با fallback به متن پیش‌فرض"""
    try:
        row = query_db("SELECT text FROM messages WHERE message_name = ?", (message_name,), one=True)
        if row and row.get('text'):
            return row['text']
        return default
    except Exception:
        return default
```

این تابع:
- ابتدا متن را از دیتابیس می‌خواند
- در صورت عدم وجود، مقدار پیش‌فرض را برمی‌گرداند
- در صورت خطا، مقدار پیش‌فرض را برمی‌گرداند

### استفاده در کد

قبل:
```python
await _safe_edit_text(query.message, "پنل ساخت تست را انتخاب کنید:", ...)
```

بعد:
```python
select_text = get_message_text('trial_panel_select', 'پنل ساخت تست را انتخاب کنید:')
await _safe_edit_text(query.message, select_text, ...)
```

---

## آینده

این سیستم آماده است برای اضافه کردن متن‌های بیشتر. برای افزودن متن قابل تغییر جدید:

1. متن پیش‌فرض را به `default_messages` در `bot/db.py` اضافه کنید
2. در handler مربوطه از `get_message_text()` استفاده کنید
3. اسکریپت `update_messages.py` را بروزرسانی کنید (اختیاری)

---

## پشتیبانی

در صورت بروز مشکل:
- اطمینان حاصل کنید که دیتابیس دارای جدول `messages` است
- اسکریپت بروزرسانی را اجرا کنید
- لاگ‌های ربات را بررسی کنید

برای گزارش باگ یا پیشنهاد، به مخزن اصلی پروژه مراجعه کنید.
